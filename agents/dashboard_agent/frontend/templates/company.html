{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">
            <i class="fas fa-building me-2"></i>Company Level Report
        </h1>
        <p class="text-muted">View company-level performance, ROI analysis and commission breakdown</p>
    </div>
</div>

<!-- Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="date_range" class="form-label">æ—¥æœŸç¯„åœ</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                    <input type="text" class="form-control" id="date_range" 
                           value="2025-07-07 è‡³ 2025-07-14" readonly
                           style="background-color: white; cursor: pointer;">
                </div>
            </div>
            <div class="col-md-4">
                <label for="company_filter" class="form-label">Company</label>
                <select class="form-select" id="company_filter">
                    <option value="">All Companies</option>
                    <option value="ByteC">ByteC</option>
                    <option value="CompanyB">Company B</option>
                    <option value="CompanyC">Company C</option>
                </select>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>Filter
                    </button>
                    <button type="button" class="btn btn-success">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KPI Overview Cards -->
<div class="row mb-4">
    <div class="col-xl-2 col-md-4">
        <div class="card bg-primary text-white mb-4">
            <div class="card-body text-center">
                <div class="small">Total Companies</div>
                <div class="fs-4 fw-bold">3</div>
                <i class="fas fa-building fa-lg mt-2"></i>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4">
        <div class="card bg-success text-white mb-4">
            <div class="card-body text-center">
                <div class="small">Total Sales</div>
                <div class="fs-4 fw-bold">$45K</div>
                <i class="fas fa-dollar-sign fa-lg mt-2"></i>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4">
        <div class="card bg-info text-white mb-4">
            <div class="card-body text-center">
                <div class="small">Total Earning</div>
                <div class="fs-4 fw-bold">$3.6K</div>
                <i class="fas fa-chart-line fa-lg mt-2"></i>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4">
        <div class="card bg-warning text-white mb-4">
            <div class="card-body text-center">
                <div class="small">Adv Commission</div>
                <div class="fs-4 fw-bold">$2.1K</div>
                <i class="fas fa-handshake fa-lg mt-2"></i>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4">
        <div class="card bg-secondary text-white mb-4">
            <div class="card-body text-center">
                <div class="small">Pub Commission</div>
                <div class="fs-4 fw-bold">$1.2K</div>
                <i class="fas fa-users fa-lg mt-2"></i>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4">
        <div class="card bg-dark text-white mb-4">
            <div class="card-body text-center">
                <div class="small">ByteC Commission</div>
                <div class="fs-4 fw-bold">$320</div>
                <i class="fas fa-star fa-lg mt-2"></i>
            </div>
        </div>
    </div>
</div>

<!-- ByteC Company Level Summary -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ¢ ByteC Company Level Summary</h5>
        <small class="text-muted">Complete company performance overview</small>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="min-width: 120px;">Company</th>
                        <th style="min-width: 150px;">Date Range</th>
                        <th style="min-width: 120px;">Total Conversion</th>
                        <th style="min-width: 150px;">Total Sales Amount</th>
                        <th style="min-width: 150px;">Total Estimated Earning</th>
                        <th style="min-width: 150px;">Total Adv Commission</th>
                        <th style="min-width: 150px;">Total Pub Commission</th>
                        <th style="min-width: 150px;">Total ByteC Commission</th>
                        <th style="min-width: 120px;">ByteC ROI</th>
                        <th style="min-width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="table-light">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary rounded-circle p-2 me-2">
                                    <i class="fas fa-building text-white"></i>
                                </div>
                                <span class="fw-bold text-primary">ByteC</span>
                            </div>
                        </td>
                        <td class="text-center">2025-07-07 è‡³ 2025-07-14</td>
                        <td class="text-center"><strong class="text-primary">1,245</strong></td>
                        <td class="text-center"><span class="text-success fw-bold">$45,230.00</span></td>
                        <td class="text-center"><span class="text-success fw-bold">$3,620.40</span></td>
                        <td class="text-center"><span class="text-info fw-bold">$2,261.50</span></td>
                        <td class="text-center"><span class="text-warning fw-bold">$1,359.10</span></td>
                        <td class="text-center"><span class="text-dark fw-bold">$320.80</span></td>
                        <td class="text-center">
                            <span class="badge bg-success px-3 py-2">15.2%</span>
                            <div class="small text-success mt-1">
                                <i class="fas fa-arrow-up"></i> +2.3%
                            </div>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('ByteC')">
                                <i class="fas fa-eye"></i> Details
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Company Comparison Chart -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">ğŸ“Š Sales Performance Comparison</h6>
            </div>
            <div class="card-body">
                <canvas id="salesChart" height="300"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">ğŸ’° Commission Breakdown</h6>
            </div>
            <div class="card-body">
                <canvas id="commissionChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ROI Analysis -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">ğŸ“ˆ ROI Analysis & Performance Metrics</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="border rounded p-3 h-100">
                    <h6 class="text-primary">ğŸ’¡ ROI Performance</h6>
                    <div class="d-flex align-items-center mb-2">
                        <div class="progress flex-grow-1 me-3" style="height: 10px;">
                            <div class="progress-bar bg-success" style="width: 85%"></div>
                        </div>
                        <span class="fw-bold text-success">15.2%</span>
                    </div>
                    <small class="text-muted">Target: 12% | Current: 15.2% âœ…</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="border rounded p-3 h-100">
                    <h6 class="text-warning">âš¡ Conversion Rate</h6>
                    <div class="d-flex align-items-center mb-2">
                        <div class="progress flex-grow-1 me-3" style="height: 10px;">
                            <div class="progress-bar bg-warning" style="width: 72%"></div>
                        </div>
                        <span class="fw-bold text-warning">3.8%</span>
                    </div>
                    <small class="text-muted">Industry Avg: 2.5% | Our: 3.8% âœ…</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="border rounded p-3 h-100">
                    <h6 class="text-info">ğŸ¯ Profit Margin</h6>
                    <div class="d-flex align-items-center mb-2">
                        <div class="progress flex-grow-1 me-3" style="height: 10px;">
                            <div class="progress-bar bg-info" style="width: 88%"></div>
                        </div>
                        <span class="fw-bold text-info">8.8%</span>
                    </div>
                    <small class="text-muted">Target: 8% | Current: 8.8% âœ…</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historical Performance -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">ğŸ“… Historical Performance Trends</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>Period</th>
                        <th>Total Sales</th>
                        <th>Total Earning</th>
                        <th>ByteC Commission</th>
                        <th>ROI</th>
                        <th>Growth</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>2025-07-07 to 2025-07-14</strong> <span class="badge bg-primary">Current</span></td>
                        <td class="text-success">$45,230.00</td>
                        <td class="text-success">$3,620.40</td>
                        <td class="text-dark">$320.80</td>
                        <td><span class="badge bg-success">15.2%</span></td>
                        <td><i class="fas fa-arrow-up text-success"></i> +12.5%</td>
                        <td><span class="badge bg-success">Excellent</span></td>
                    </tr>
                    <tr>
                        <td>2025-06-30 to 2025-07-06</td>
                        <td class="text-success">$40,205.00</td>
                        <td class="text-success">$3,216.40</td>
                        <td class="text-dark">$285.20</td>
                        <td><span class="badge bg-success">14.8%</span></td>
                        <td><i class="fas fa-arrow-up text-success"></i> +8.2%</td>
                        <td><span class="badge bg-success">Good</span></td>
                    </tr>
                    <tr>
                        <td>2025-06-23 to 2025-06-29</td>
                        <td class="text-success">$37,150.00</td>
                        <td class="text-success">$2,972.00</td>
                        <td class="text-dark">$263.50</td>
                        <td><span class="badge bg-warning">13.2%</span></td>
                        <td><i class="fas fa-arrow-up text-warning"></i> +3.1%</td>
                        <td><span class="badge bg-warning">Average</span></td>
                    </tr>
                    <tr>
                        <td>2025-06-16 to 2025-06-22</td>
                        <td class="text-success">$36,025.00</td>
                        <td class="text-success">$2,882.00</td>
                        <td class="text-dark">$252.10</td>
                        <td><span class="badge bg-warning">12.8%</span></td>
                        <td><i class="fas fa-arrow-down text-danger"></i> -1.5%</td>
                        <td><span class="badge bg-warning">Below Target</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Data Source Information -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Data Source:</strong> Company-level data aggregated from DMP-agent via Google SQL. 
            ROI calculations include all operational costs and commission structures.
        </div>
    </div>
</div>

<script>
// åˆå§‹åŒ–æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨
$(document).ready(function() {
    // è·å–å½“å‰çš„æ—¥æœŸå€¼
    var currentStartDate = $('#start_date').val() || moment().subtract(6, 'days').format('YYYY-MM-DD');
    var currentEndDate = $('#end_date').val() || moment().format('YYYY-MM-DD');
    
    $('#date_range').daterangepicker({
        startDate: moment(currentStartDate),
        endDate: moment(currentEndDate),
        opens: 'left',
        locale: {
            format: 'YYYY-MM-DD',
            separator: ' è‡³ ',
            applyLabel: 'ç¢ºå®š',
            cancelLabel: 'å–æ¶ˆ',
            fromLabel: 'å¾',
            toLabel: 'åˆ°',
            customRangeLabel: 'è‡ªå®šç¾©ç¯„åœ',
            weekLabel: 'W',
            daysOfWeek: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'],
            monthNames: ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ',
                        'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ']
        },
        ranges: {
           'ä»Šå¤©': [moment(), moment()],
           'æ˜¨å¤©': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'æœ€è¿‘7å¤©': [moment().subtract(6, 'days'), moment()],
           'æœ€è¿‘30å¤©': [moment().subtract(29, 'days'), moment()],
           'é€™å€‹æœˆ': [moment().startOf('month'), moment().endOf('month')],
           'ä¸Šå€‹æœˆ': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    }, function(start, end, label) {
        $('#start_date').val(start.format('YYYY-MM-DD'));
        $('#end_date').val(end.format('YYYY-MM-DD'));
        $('#date_range').val(start.format('YYYY-MM-DD') + ' è‡³ ' + end.format('YYYY-MM-DD'));
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoadingState();
        
        // è‡ªåŠ¨æäº¤è¡¨å•ä»¥è·å–æ–°æ•°æ®
        $('#filterForm').submit();
    });
    
    // åˆå§‹åŒ–å›¾è¡¨
    initCharts();
});

// åˆå§‹åŒ–å›¾è¡¨
function initCharts() {
    // Sales Performance Chart
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [{
                label: 'Sales Amount ($)',
                data: [36025, 37150, 40205, 45230],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    
    // Commission Breakdown Chart
    const commissionCtx = document.getElementById('commissionChart').getContext('2d');
    new Chart(commissionCtx, {
        type: 'doughnut',
        data: {
            labels: ['Adv Commission', 'Pub Commission', 'ByteC Commission'],
            datasets: [{
                data: [2261.50, 1359.10, 320.80],
                backgroundColor: ['#17a2b8', '#ffc107', '#343a40'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoadingState() {
    // åœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºåŠ è½½æç¤º
    $('body').prepend('<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background-color: rgba(255,255,255,0.8); z-index: 9999;"><div class="text-center"><div class="spinner-border text-primary mb-2" role="status"></div><div>æ­£åœ¨åŠ è¼‰æ•¸æ“š...</div></div></div>');
}

// æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½
function viewDetails(company) {
    alert(`View detailed breakdown for ${company}\n\nThis will navigate to a detailed company analysis page.`);
}

// Set current page as active in navigation
document.addEventListener('DOMContentLoaded', function() {
    const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
    navLinks.forEach(link => link.classList.remove('active'));
    
    const companyLink = document.querySelector('a[href="/company"]');
    if (companyLink) {
        companyLink.classList.add('active');
    }
});
</script>
{% endblock %} 