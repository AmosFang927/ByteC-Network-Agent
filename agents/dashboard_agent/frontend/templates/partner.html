{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">
            <i class="fas fa-handshake me-2"></i>Partner Performance Report
        </h1>
        <p class="text-muted">View partner-level conversion performance and commission statistics</p>
    </div>
</div>

<!-- Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="date_range" class="form-label">æ—¥æœŸç¯„åœ</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                    <input type="text" class="form-control" id="date_range" 
                           value="2025-07-07 è‡³ 2025-07-14" readonly
                           style="background-color: white; cursor: pointer;">
                </div>
            </div>
            <div class="col-md-4">
                <label for="partner_filter" class="form-label">Partner</label>
                <select class="form-select" id="partner_filter">
                    <option value="">All Partners</option>
                    <option value="ByteC">ByteC</option>
                    <option value="DeepLeaper">DeepLeaper</option>
                    <option value="RAMPUP">RAMPUP</option>
                </select>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>Filter
                    </button>
                    <button type="button" class="btn btn-success">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card bg-primary text-white mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small">Total Partners</div>
                        <div class="fs-4 fw-bold">3</div>
                    </div>
                    <i class="fas fa-users fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card bg-success text-white mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small">Total Conversions</div>
                        <div class="fs-4 fw-bold">1,245</div>
                    </div>
                    <i class="fas fa-chart-line fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card bg-warning text-white mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small">Total Sales</div>
                        <div class="fs-4 fw-bold">$45,230</div>
                    </div>
                    <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card bg-info text-white mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small">Total Commission</div>
                        <div class="fs-4 fw-bold">$3,620</div>
                    </div>
                    <i class="fas fa-hand-holding-usd fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Partner Performance Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ‘¥ Partner Performance Summary</h5>
        <small class="text-muted">æŒ‰ä¼˜å…ˆçº§æ’åº - Partner ç»´åº¦ç»Ÿè®¡</small>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th style="min-width: 60px;">Rank</th>
                        <th style="min-width: 150px;">Partner Name</th>
                        <th style="min-width: 120px;">Total Conversion</th>
                        <th style="min-width: 150px;">Sales Amount (USD)</th>
                        <th style="min-width: 150px;">Estimated Earning</th>
                        <th style="min-width: 150px;">Adv Commission</th>
                        <th style="min-width: 150px;">Pub Commission</th>
                        <th style="min-width: 120px;">Performance</th>
                        <th style="min-width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge bg-primary">1</span></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-success rounded-circle me-2 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-building text-white"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">ByteC</div>
                                    <small class="text-muted">Primary Partner</small>
                                </div>
                            </div>
                        </td>
                        <td><strong>856</strong></td>
                        <td><span class="text-success fw-bold">$32,450.00</span></td>
                        <td><span class="text-success fw-bold">$2,896.50</span></td>
                        <td><span class="text-info">$1,622.50</span></td>
                        <td><span class="text-warning">$1,274.00</span></td>
                        <td>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: 95%"></div>
                            </div>
                            <small class="text-success">95% Performance</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="drillDown('partner', 'ByteC')">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td><span class="badge bg-secondary">2</span></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-warning rounded-circle me-2 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-rocket text-white"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">DeepLeaper</div>
                                    <small class="text-muted">Growth Partner</small>
                                </div>
                            </div>
                        </td>
                        <td><strong>289</strong></td>
                        <td><span class="text-success fw-bold">$8,920.00</span></td>
                        <td><span class="text-success fw-bold">$535.20</span></td>
                        <td><span class="text-info">$446.00</span></td>
                        <td><span class="text-warning">$89.20</span></td>
                        <td>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: 78%"></div>
                            </div>
                            <small class="text-warning">78% Performance</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="drillDown('partner', 'DeepLeaper')">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td><span class="badge bg-secondary">3</span></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-info rounded-circle me-2 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-chart-line text-white"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">RAMPUP</div>
                                    <small class="text-muted">Strategic Partner</small>
                                </div>
                            </div>
                        </td>
                        <td><strong>100</strong></td>
                        <td><span class="text-success fw-bold">$3,860.00</span></td>
                        <td><span class="text-success fw-bold">$188.90</span></td>
                        <td><span class="text-info">$193.00</span></td>
                        <td><span class="text-warning">$-4.10</span></td>
                        <td>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" style="width: 62%"></div>
                            </div>
                            <small class="text-info">62% Performance</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="drillDown('partner', 'RAMPUP')">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Partner + Source Level Summary -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">ğŸ” Partner + Source Level Summary</h5>
        <small class="text-muted">Detailed breakdown by partner and source combination</small>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Partner + Source</th>
                        <th>Conversion</th>
                        <th>Sales Amount</th>
                        <th>Estimated Earning</th>
                        <th>Performance Trend</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge bg-primary">1</span></td>
                        <td><strong>ByteC + RPID455DXP</strong></td>
                        <td>723</td>
                        <td><span class="text-success">$28,920.00</span></td>
                        <td><span class="text-success">$2,603.80</span></td>
                        <td><i class="fas fa-arrow-up text-success"></i> +15%</td>
                    </tr>
                    <tr>
                        <td><span class="badge bg-secondary">2</span></td>
                        <td><strong>DeepLeaper + DL_MOBILE</strong></td>
                        <td>289</td>
                        <td><span class="text-success">$8,920.00</span></td>
                        <td><span class="text-success">$535.20</span></td>
                        <td><i class="fas fa-arrow-up text-success"></i> +8%</td>
                    </tr>
                    <tr>
                        <td><span class="badge bg-secondary">3</span></td>
                        <td><strong>ByteC + RP_SECONDARY</strong></td>
                        <td>133</td>
                        <td><span class="text-success">$3,530.00</span></td>
                        <td><span class="text-success">$292.70</span></td>
                        <td><i class="fas fa-arrow-down text-danger"></i> -3%</td>
                    </tr>
                    <tr>
                        <td><span class="badge bg-secondary">4</span></td>
                        <td><strong>RAMPUP + RU_DIRECT</strong></td>
                        <td>100</td>
                        <td><span class="text-success">$3,860.00</span></td>
                        <td><span class="text-success">$188.90</span></td>
                        <td><i class="fas fa-minus text-muted"></i> 0%</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Data Source Information -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Data Source:</strong> Partner performance data is retrieved from DMP-agent via Google SQL. 
            Commission calculations are based on real-time conversion tracking.
        </div>
    </div>
</div>

<script>
// åˆå§‹åŒ–æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨
$(document).ready(function() {
    // è·å–å½“å‰çš„æ—¥æœŸå€¼
    var currentStartDate = $('#start_date').val() || moment().subtract(6, 'days').format('YYYY-MM-DD');
    var currentEndDate = $('#end_date').val() || moment().format('YYYY-MM-DD');
    
    $('#date_range').daterangepicker({
        startDate: moment(currentStartDate),
        endDate: moment(currentEndDate),
        opens: 'left',
        locale: {
            format: 'YYYY-MM-DD',
            separator: ' è‡³ ',
            applyLabel: 'ç¢ºå®š',
            cancelLabel: 'å–æ¶ˆ',
            fromLabel: 'å¾',
            toLabel: 'åˆ°',
            customRangeLabel: 'è‡ªå®šç¾©ç¯„åœ',
            weekLabel: 'W',
            daysOfWeek: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'],
            monthNames: ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ',
                        'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ']
        },
        ranges: {
           'ä»Šå¤©': [moment(), moment()],
           'æ˜¨å¤©': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'æœ€è¿‘7å¤©': [moment().subtract(6, 'days'), moment()],
           'æœ€è¿‘30å¤©': [moment().subtract(29, 'days'), moment()],
           'é€™å€‹æœˆ': [moment().startOf('month'), moment().endOf('month')],
           'ä¸Šå€‹æœˆ': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    }, function(start, end, label) {
        $('#start_date').val(start.format('YYYY-MM-DD'));
        $('#end_date').val(end.format('YYYY-MM-DD'));
        $('#date_range').val(start.format('YYYY-MM-DD') + ' è‡³ ' + end.format('YYYY-MM-DD'));
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoadingState();
        
        // è‡ªåŠ¨æäº¤è¡¨å•ä»¥è·å–æ–°æ•°æ®
        $('#filterForm').submit();
    });
});

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoadingState() {
    // åœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºåŠ è½½æç¤º
    $('body').prepend('<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background-color: rgba(255,255,255,0.8); z-index: 9999;"><div class="text-center"><div class="spinner-border text-primary mb-2" role="status"></div><div>æ­£åœ¨åŠ è¼‰æ•¸æ“š...</div></div></div>');
}

// é’»å–åŠŸèƒ½
function drillDown(type, value) {
    alert(`Drill down into ${type}: ${value}\n\nThis will show detailed breakdown for this specific partner.`);
}

// Set current page as active in navigation
document.addEventListener('DOMContentLoaded', function() {
    const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
    navLinks.forEach(link => link.classList.remove('active'));
    
    const partnerLink = document.querySelector('a[href="/partner"]');
    if (partnerLink) {
        partnerLink.classList.add('active');
    }
});
</script>

<style>
.avatar-sm {
    width: 32px;
    height: 32px;
}
</style>
{% endblock %} 